# AI 讲解成本分析：生成 vs 存储

## 📊 成本对比总览

### 场景设定
- **模型**: GPT-4 Turbo Preview
- **示例书籍**: 300 页教材，每页 4 个 Auto Stickers
- **存储方案**: Supabase PostgreSQL

---

## 1. 生成成本（OpenAI API）

### 定价（2024年）
```
GPT-4 Turbo Preview:
  - Input:  $0.01 / 1K tokens
  - Output: $0.03 / 1K tokens
```

### 单次 Auto Explain 成本
根据 `src/lib/openai/cost-tracker.ts` 的估算：

```typescript
autoExplain: {
  avgInputTokens: 2000,   // 页面文本 + Prompt
  avgOutputTokens: 1500,  // 4 个 Stickers 的 Markdown
}
```

**计算**：
```
输入成本  = (2000 ÷ 1000) × $0.01 = $0.02
输出成本  = (1500 ÷ 1000) × $0.03 = $0.045
────────────────────────────────────
每页生成成本 = $0.065 ≈ $0.07
```

### 整本书成本
```
300 页 × $0.07 = $21.00 per book
```

---

## 2. 存储成本（Supabase）

### 数据量估算

#### 单个 Sticker 数据结构
```sql
CREATE TABLE stickers (
  id UUID,                    -- 16 bytes
  user_id UUID,               -- 16 bytes
  course_id UUID,             -- 16 bytes
  file_id UUID,               -- 16 bytes
  type sticker_type,          -- 4 bytes
  page INTEGER,               -- 4 bytes
  anchor_text TEXT,           -- ~50 bytes
  anchor_rect JSONB,          -- ~100 bytes (optional)
  parent_id UUID,             -- 16 bytes (nullable)
  content_markdown TEXT,      -- ~500 bytes ⭐
  folded BOOLEAN,             -- 1 byte
  depth INTEGER,              -- 4 bytes
  created_at TIMESTAMPTZ      -- 8 bytes
);

-- Total per sticker: ~750 bytes
```

#### 索引开销
```sql
-- 假设有以下索引
CREATE INDEX idx_file_page ON stickers(file_id, page);
CREATE INDEX idx_user_course ON stickers(user_id, course_id);

-- 索引额外开销：约 150 bytes/sticker
```

**总计**：~900 bytes/sticker

#### 整本书存储量
```
300 页 × 4 个 Stickers = 1,200 个 Stickers
1,200 × 900 bytes = 1.08 MB per book
```

### Supabase 定价

| 项目 | Free Tier | Pro Tier |
|------|-----------|----------|
| 数据库存储 | 500 MB | 8 GB included |
| 超额费用 | - | **$0.125/GB/月** |

### 单本书月存储成本
```
1.08 MB × ($0.125 / 1024 MB) = $0.000132/月
```

### 年存储成本
```
$0.000132 × 12 月 = $0.00158 ≈ $0.002/年
```

---

## 3. 临界点分析（Break-Even Point）

### 核心问题
**存储讲解 vs 每次重新生成，复用多少次划算？**

### 计算公式
```
生成成本 = $21.00（一次性）
存储成本 = $0.002/年（持续）

临界时间 = 生成成本 ÷ (月存储成本 × 12)
         = $21.00 ÷ ($0.000132 × 12)
         = $21.00 ÷ $0.00158
         = 13,291 年 🤯
```

### 换个角度：复用次数

假设不存储，每次有新用户上传同一本书都重新生成：

| 用户数 | 累计生成成本 | 存储成本（1年） | 节省金额 |
|--------|-------------|----------------|---------|
| 1      | $21.00      | $0.002         | -$20.99 |
| 2      | $42.00      | $0.002         | $41.99  |
| 5      | $105.00     | $0.002         | $104.99 |
| 10     | $210.00     | $0.002         | $209.99 |
| 50     | $1,050.00   | $0.002         | $1,049.99 |
| 100    | $2,100.00   | $0.002         | $2,099.99 |

**结论**：只需复用 **2 次**，存储就已经划算！

---

## 4. 实际场景分析

### 场景 A：热门教材（如《微积分 第8版》）

**假设**：
- 你的平台有 1000 个学生
- 每学期 200 个学生选修微积分
- 每年 400 个学生会上传这本书

**首年成本对比**：
```
不存储（每次生成）:
  400 次 × $21 = $8,400

存储复用:
  首次生成: $21
  存储费用: $0.002
  总计: $21.002

节省: $8,378.998 (99.75% 成本削减)
```

### 场景 B：小众资料（只有 1 个用户上传）

**不划算的情况**：
- 如果一本 PDF 终其一生只被 1 个用户上传过
- 那么存储它一年就损失了 $0.002（微不足道）

**保护措施**：
```typescript
// 设置清理策略
interface CacheRetentionPolicy {
  minAccessCount: 2,          // 至少被访问 2 次才值得长期保留
  cleanupAfterDays: 365,      // 1 年无人访问则清理
  keepPopularBooks: true      // 热门书籍永久保留
}
```

### 场景 C：规模化平台

假设你的平台成长到：
- 10,000 个活跃用户
- 5,000 本不同的 PDF
- 平均每本被上传 5 次

**月度对比**：
```
不存储（重复生成）:
  5,000 本 × 5 次 × $21 = $525,000 😱

存储复用:
  首次生成: 5,000 × $21 = $105,000
  月存储: 5,000 × 1.08 MB × $0.125/GB × (1/1024)
        = 5.4 GB × $0.125 = $0.675/月
  首月总计: $105,000.675
  后续月度: $0.675/月

年度成本:
  不存储: $525,000 × 12 = $6,300,000
  存储: $105,000 + ($0.675 × 12) = $105,008.10

节省: $6,194,991.90 (98.3% 削减)
```

---

## 5. 其他隐性成本

### 存储方案的额外开销

#### A. 数据库读取成本（很低）
Supabase 定价：
- 免费层：50,000+ 行/秒读取能力
- 读取查询：几乎免费（包含在套餐内）

**影响**：可忽略不计

#### B. CDN/带宽成本（如果使用）
- Supabase 免费层：50 GB egress
- 超额：$0.09/GB

单个 Sticker 传输：~1 KB
```
传输 1000 次 = 1 MB
需要传输 50,000,000 次（5000万次）才会超额
```

**影响**：可忽略不计

#### C. 数据库备份
- Supabase 自动备份包含在订阅内
- 增量备份，压缩率高

**影响**：可忽略不计

### 生成方案的隐性成本

#### A. API 请求延迟
- 每次生成需要等待 5-10 秒
- 用户体验差

#### B. API 速率限制
- OpenAI 有 RPM (Requests Per Minute) 限制
- 高并发时可能需要排队

#### C. 失败重试成本
- 网络故障需要重试
- 每次重试都计费

---

## 6. 终极结论

### 💡 核心答案

**存储成本几乎可以忽略不计！**

| 指标 | 生成（每次） | 存储（复用） | 比率 |
|------|------------|------------|------|
| 首次成本 | $21.00 | $21.00 | 1:1 |
| 第2次 | $42.00 | $21.00 | 2:1 |
| 第10次 | $210.00 | $21.00 | 10:1 |
| 年存储费 | - | $0.002 | - |
| 临界复用次数 | - | **2 次** | - |

### 📈 推荐策略

```typescript
// 智能缓存策略
const CACHE_POLICY = {
  // 1. 始终存储 Auto Stickers（命中率高）
  cacheAutoStickers: true,
  
  // 2. 热度衰减清理
  retentionRules: {
    hot: { minAccess: 10, keepForever: true },    // 热门永久保留
    warm: { minAccess: 2, keepDays: 365 },        // 温和保留1年
    cold: { minAccess: 1, keepDays: 90 }          // 冷门保留3个月
  },
  
  // 3. 智能预测（可选）
  predictiveCache: {
    enabled: true,
    // 课程开始前预生成热门教材讲解
    preGeneratePopularBooks: true
  }
}
```

### ⚖️ 风险评估

| 风险 | 严重性 | 缓解措施 |
|------|--------|---------|
| 存储成本爆炸 | 🟢 极低 | 1.08 MB/书，需要 476 本书才到 1 GB |
| 过时讲解 | 🟡 中等 | 版本控制 + 定期重新生成 |
| 隐私泄露 | 🟡 中等 | 用户可选分享 + 内容哈希 |
| 数据库性能 | 🟢 低 | PostgreSQL 对百万级记录轻松处理 |

### 🎯 最终建议

**毫无疑问应该存储！**理由：
1. ✅ 存储成本相比生成成本可以忽略（**10,000:1 比率**）
2. ✅ 复用 2 次即可回本（甚至复用 1.001 次都划算）
3. ✅ 用户体验显著提升（秒开 vs 等待 10 秒）
4. ✅ 规模化后节省呈指数级增长

**唯一的问题不是"是否应该存"，而是"如何更好地存"！**

---

## 附录：扩展计算

### 其他模型的对比

| 模型 | 每页成本 | 300页成本 | 存储/生成比 |
|------|---------|----------|------------|
| GPT-4 Turbo | $0.065 | $21.00 | 1:10,500 |
| GPT-4 | $0.150 | $45.00 | 1:22,500 |
| GPT-3.5 Turbo | $0.0025 | $0.75 | 1:375 |

**结论**：即使用最便宜的 GPT-3.5 Turbo，存储仍然比重复生成划算 375 倍！

### 数据库选择对比

| 数据库 | 月费（8GB） | 优势 |
|-------|-----------|------|
| Supabase | $0.125/GB | PostgreSQL全功能 |
| MongoDB Atlas | $0.25/GB | 文档型，更灵活 |
| AWS RDS | $0.115/GB | 高可用性 |
| Firebase | $0.18/GB | 实时同步 |

**影响**：即使用最贵的 MongoDB，存储成本仍然可以忽略

---

**最后更新**: 2026-01-10
**数据来源**: 
- OpenAI 官方定价
- Supabase 官方定价
- 项目内部 cost-tracker.ts
