# StudentAid Web - PRD

> **文档定位**：产品需求基线，定义"做什么"和"为什么"；技术实现见03/04文档。

---

## 一、产品定位

**目标用户**：
1. **学生**：理工科/商科大学生，整学期跟课学习 + 考前复习
2. **管理员**：系统运营人员，负责成本监控、配额调整、系统健康检查

**核心价值**：以课程为单位管理PDF + AI逐页讲解 + 考点梳理

**三大能力**：
1. 按课程组织Lecture/Homework/Exam/Other PDF
2. 同屏完成"阅读PDF + AI讲解(贴纸) + 追问"
3. 文档/章节级AI总结

**两大场景**：
- **跟课学习**：每周课后结合讲义理解概念、完成作业，贴纸记录学习轨迹
- **考前复习**：快速生成文档/课程总结，梳理高频考点，定位已标记难点

**角色权限**：
| 角色 | 数据范围 | 核心权限 | 配额限制 |
|------|---------|---------|---------|
| 学生 | 仅自己的课程/文件/AI数据 | 上传、讲解、问答、总结 | 受配额限制 |
| 管理员 | 全局聚合数据（不含具体PDF内容） | 查看统计、调整配额、监控告警 | **无限配额** |

---

## 二、功能模块

### 2.0 页面地图

| 页面编号 | 页面名称 | 路由 | 核心功能 | 前置条件 | 跳转至 |
|---------|---------|------|---------|---------|--------|
| P1 | 登录页 | /login | 邮箱+密码登录 | - | P3 |
| P2 | 注册页 | /register | 邮箱注册+验证 | - | P1 |
| P3 | 课程列表 | /courses | 创建/查看课程 | 已登录+邮箱已验证 | P4（点击课程卡片） |
| P4 | 课程详情 | /courses/[id] | 上传PDF、查看文件列表、显示配额警告 | 已登录+课程存在 | P5（点击文件行） |
| P5 | 学习页 | /courses/[id]/files/[fileId] | 三栏：PDF阅读+贴纸+问答 | 已登录+文件存在 | P7（配额警告链接） |
| P7 | 设置页 | /settings | 语言设置、Usage标签页（配额详情+成本分析） | 已登录 | - |
| Admin | 管理后台 | /admin | 全局统计、配额覆盖、Worker监控 | ADMIN_SECRET认证 | - |

### 2.1 P5页面结构（核心学习页）

**三栏布局**：
* **左侧**：PDF阅读器（分页/连续滚动模式切换、缩放、记忆lastReadPage） - 40-50%宽度
* **中栏**：贴纸栏（自动讲解 + 选中讲解） - 25-30%宽度
* **右栏**：问答与总结区 - 25-30%宽度

**布局调整**：拖拽分隔条调整宽度，偏好保存在localStorage

### 2.2 四类AI能力

| 能力 | 触发方式 | 配额规则 | 缓存共享 |
|------|---------|---------|---------|
| 自动讲解 | 点击"Explain From This Page"（滑动窗口生成） | autoExplain (300次/月) | ✅ 跨用户 |
| 选中讲解 | 选中文本 → AI讲解 | learningInteractions | ❌ 仅自己 |
| 图片解释 | 手动框选区域 | learningInteractions | ✅ 跨用户 |
| 问答 | 问答区输入问题 | learningInteractions | ❌ 仅自己 |
| 总结 | 文档/章节/课程总结按钮 | 各自独立配额桶 | ❌ 仅自己 |

**PDF类型差异**：Lecture侧重概念讲解，Homework/Exam侧重考点分析（不直接给答案）

**区域选择模式**（自动讲解扩展）：
* 手动绘制矩形选择特定图片区域进行解释
* 可跨页面选择多个区域，统一生成一个解释贴纸
* 缓存命中仍消耗配额（用户主动操作）

**滑动窗口自动讲解**（v2.0智能生成）：
* 点击一次自动生成当前页及周围页面的讲解（前2页+当前页+后5页）
* 生成优先级顺序：当前页 → +1 → -1 → +2 → +3 → -2 → +4 → +5（优先生成用户最可能阅读的页面）
* 用户滚动阅读时窗口自动扩展，持续生成未覆盖页面
* PDF类型检测：自动识别PPT风格（图多文少）与文本型（段落密集）PDF，调整生成策略
* 版本管理：支持重新生成讲解并在不同版本间切换
* 会话限制：每个用户每个文档最多1个活跃自动讲解会话

### 2.3 贴纸机制

**类型**：
* 自动贴纸（Auto）：
  - **PPT风格PDF**：每页生成1个全页贴纸，覆盖整页内容进行综合讲解
  - **文本密集型PDF**：每页生成2-6条贴纸，按段落对齐原文位置，支持hover溯源高亮
* 手动贴纸（Manual）：用户选中触发，支持追问链（最多10层深度）

**Hover溯源**（文本密集型PDF）：鼠标悬停贴纸时，左侧PDF自动高亮对应段落区域（2px蓝色边框+半透明填充），帮助用户定位讲解内容的原文位置

**跨用户内容去重**（v2.0）：相同PDF内容的自动贴纸跨用户共享缓存（基于内容哈希），降低成本、提升速度；不共享用户上传的PDF或个人学习数据

**持久化**：
* 支持折叠/展开，状态持久化
* 单条贴纸最大高度300-400px，超出内部滚动
* 重开文档恢复所有贴纸及折叠状态

**数据模型**：见03_API §3.0.1
* anchor字段支持：文本片段（textSnippet）、图片位置（rect）、或图片区域数组（anchors[]）

**图片检测与解释**：
* PDF上传时自动提取图片位置（检测算法见04_TECH）
* 悬停显示检测到的图片高亮边框
* 手动框选区域生成解释贴纸，跨用户共享图片解释缓存

### 2.3.1 图片检测反馈机制（数据闭环预留）

> **注**：本章节为未来算法优化预留的数据管道，MVP阶段不作为验收标准

**目的**：收集检测错误样本，优化检测算法

**反馈类型**：误检、漏检、边界错误

**用户操作**：点击高亮边框/手动绘制矩形 → 反馈按钮

**数据收集**：存储表`image_feedback`，字段：`user_id`, `file_id`, `page`, `feedback_type`, `correct_rect`, `comment`

**漏检自动修正**：用户标记的漏检图片自动添加到`detected_images`表（`detection_method = 'manual'`），其他用户可见

**限流**：10次反馈/用户/小时

### 2.4 扫描件处理

* 上传时检测文本层可用性（检测算法见04_TECH §2.3）
* P5右侧提示"不支持AI讲解"，隐藏AI入口
* 左侧PDF阅读器正常可用

### 2.4.5 共享上下文库（v2.0智能上下文）

**目的**：解决AI只能看到当前页内容的局限，提升跨页引用和概念理解的准确性

**工作原理**：首次打开PDF时，后台自动提取定义/公式/定理/概念/原理等知识点，跨用户共享（基于PDF文件哈希），AI讲解时自动检索相关知识点

**提取策略**：
* 分批处理：3000-5000词/批
* 类型识别：Definition/Formula/Theorem/Concept/Principle
* 质量控制：AI自评分（≥0.7阈值）+ 去重
* 英文优先：非英文内容自动翻译为英文存储

**用户体验**：
* P4文件列表显示实时进度
* Toast提示提取完成/失败，失败可手动重试
* AI自动利用上下文库，用户无需手动操作

**配额与限制**：
* 提取配额：20个PDF/用户/月（计入contextExtraction配额桶）
* 存储限制：5GB/用户，50文件/课程，100MB/文件，200页/文件
* 检索开销：<200ms延迟增加

### 2.5 统一富文本格式

所有AI输出统一为**Markdown文本**（格式规范见03_API §3.0.3）：
* 格式：标题/粗体/列表/表格/引用
* 公式：行内`$...$`，块级`$$...$$`（KaTeX渲染）
* 代码：三反引号+语言标记
* 约束：后端不返回HTML，前端统一用`MarkdownRenderer`

### 2.6 数据收集规范

#### 必须收集（MVP核心）
1. **账户身份**：user_id, email, created_at, email_confirmed_at, last_login_at
2. **课程结构**：course_id, name, school, term, created_at, last_visited_at
3. **PDF元数据**：file_id, name, type, page_count, is_scanned, uploaded_at, last_read_page, extraction_status
4. **图片检测数据**：detected_images表（file_id, page, position, width, height）
5. **AI学习数据**：贴纸（完整模型见03_API §3.0.1）、问答/总结结果
6. **上下文库数据**：pdf_context_entries表、user_context_scope表
7. **配额数据**：bucket, used, limit, reset_at
8. **用户偏好**：user_preferences表（ui_locale, explain_locale）

#### 建议收集（MVP阶段不做，未来可选）
6. **轻量行为**：has_used_auto_explain, has_used_manual_explain, has_generated_summary（仅boolean）

> **MVP说明**：埋点功能MVP阶段不实现，仅预留字段设计
7. **PDF去重**：pdf_content_hash（SHA-256，成本优化）
8. **设备与客户端**：user_agent, device_type, locale, timezone, client_version（兼容性测试、排错）
9. **安全与审计**：登录审计（userId, eventType, createdAt, ipPrefix/hash）、会话安全信号（留存30-90天）
10. **运行监控与成本**：请求级指标（requestId, endpoint, statusCode, latencyMs）、AI调用指标（model, inputTokens, outputTokens, costUsdApprox）、客户端性能（LCP, TTFB）
11. **用户反馈**：userId, courseId/fileId/page（可选）, message, includeDiagnostics
12. **计费与权限预留**：plan（free/trial/pro）, quotaOverrides, billingCustomerId, entitlements（MVP阶段所有用户默认free）

#### 不收集（明确禁止）
- ❌ 真实姓名、手机号、身份证、学号
- ❌ 完整IP地址、地理位置、设备指纹
- ❌ 详细行为时间线（点击流、停留时长、光标轨迹）
- ❌ 第三方追踪（Google Analytics、Mixpanel等）

### 2.7 语言设置

**支持语言**：英文（en）、中文（zh）

**独立设置**：
* **UI语言**：界面显示语言（按钮、菜单、提示文案）
* **AI解释语言**：所有AI生成内容的语言（自动讲解、选中讲解、问答、总结）

**设置入口**：Settings页面 > Language标签页

**首次登录**：新用户首次登录时显示语言选择模态框，需同时设置UI语言和AI解释语言

**切换行为**：切换后触发页面刷新，偏好保存在`user_preferences`表

### 2.8 数据生命周期管理

#### 2.8.1 删除行为规则

| 删除操作 | 触发方式 | 级联删除范围 | 配额影响 | 可撤销 | 二次确认 |
|---------|---------|-------------|---------|--------|---------|
| 删除课程 | P4右上角"Delete Course" | 该课程下所有文件、贴纸/问答/总结、detected_images、user_context_scope | 不退还 | ❌ | ✅ 输入课程名 |
| 删除文件 | P4文件列表"Delete" | 该文件的所有贴纸/问答/总结、detected_images | 不退还 | ❌ | ✅ 弹窗确认 |
| 删除账户 | P7 Settings底部 | 所有课程（级联删除）、quota、user_preferences、audit_log（30天后清理） | N/A | ❌ | ✅ 输入"DELETE" |

**共享数据保护**：
- `pdf_context_entries`（知识点库）：跨用户共享，删除文件时仅解除user_context_scope关联，不删除条目
- `shared_sticker_cache`（自动贴纸缓存）：基于内容哈希，删除文件后缓存保留
- `detected_images`：基于file_id，删除文件时同步删除

#### 2.8.2 数据保留期

| 数据类型 | 正常保留期 | 删除后保留期 |
|---------|-----------|-------------|
| 课程/文件 | 永久（除非用户删除） | 0（立即删除） |
| AI生成内容 | 永久 | 0（级联删除） |
| audit_log | 30天 | 30天 |
| Worker任务记录 | 完成后7天 | - |
| 共享缓存 | 永久 | 永久（即使源文件删除） |

### 2.9 管理员功能

**目标用户**：系统管理员、运营人员

**核心能力**：
1. 用户行为分析（活跃度、使用模式、留存率）
2. 成本追踪（按操作/用户/时间段统计AI调用成本）
3. 系统健康监控（Worker状态、队列长度、错误率）
4. 配额覆盖（为特定用户手动调整配额限制）

**访问权限**：
* 认证方式：`ADMIN_SECRET`环境变量
* 请求头：`x-admin-secret: $ADMIN_SECRET`
* 失败返回：401 ADMIN_UNAUTHORIZED

**关键指标**：
* 用户指标：总用户数、活跃用户、新增用户
* 成本指标：总成本、成本趋势、成本分布
* 性能指标：错误率、延迟百分位数（P50/P95/P99）
* Worker健康度：最后运行时间、待处理任务数、僵尸任务数
* 缓存效率：缓存命中率、成本节省估算

**数据隐私**：仅查看聚合数据和匿名化指标，不包含PDF内容或详细用户行为轨迹

### 2.10 使用情况与账单

**目标用户**：所有注册用户

**访问路径**：`/settings`页面的Usage标签页（统一入口）

**核心信息模块**：

1. **当期成本估算**：当前周期实际成本、基于当前使用率的月度预估成本、警告级别（绿/黄/红）、周期进度

2. **Token使用分析**：输入Token总量、输出Token总量、可视化图表（饼图或柱状图）

3. **成本分解**：按操作类型统计（自动讲解、选中讲解、问答、总结等）、Token消耗量、调用次数、预估成本、占比分析

4. **配额使用情况**：所有配额桶的使用率、进度条可视化（绿<70% | 黄70-90% | 红>90%）、剩余次数提示

5. **重置日期信息**：下次配额重置日期、剩余天数倒计时、注册日期说明

**成本计算逻辑**：
* 成本估算基于实际Token使用量和OpenAI当前定价
* 投影成本 = (当前成本 / 已过天数) × 30天
* 仅用于参考，不作为实际计费依据

**与其他页面交互**：
* P4课程详情页："View details"链接跳转至`/settings?tab=usage`
* P5学习页：配额不足提示中包含跳转链接至`/settings?tab=usage`

**边界情况**：数据加载失败、新用户（无使用记录）、配额已用尽

---

## 三、配额与限流策略

### 3.1 配额粒度设计

**原则**：按账户全局配额，所有课程共享

| 类型 | 粒度 | 默认值 |
|------|------|--------|
| 课程数量 | (userId) | 6门 |
| AI配额 | (userId) | 见下表 |

**AI配额桶**（按账户全局）：

| 配额桶 | 包含操作 | 限制 | HTTP错误码 |
|--------|---------|------|------------|
| learningInteractions | 选中讲解 + 图片解释 + 问答 | 150次/月 | 403 |
| documentSummary | 文档总结 | 100次/月 | 403 |
| sectionSummary | 章节总结 | 65次/月 | 403 |
| courseSummary | 课程级总结 | 15次/月 | 403 |
| autoExplain | 自动讲解（页级生成） | 300次/月 | 403 |
| contextExtraction | PDF知识点提取 | 20个文件/月 | 403 |

**HTTP状态码约定**：配额用尽返回HTTP 403 + `QUOTA_EXCEEDED`；请求频率超限返回HTTP 429 + `RATE_LIMIT_EXCEEDED`

**配额说明**：所有课程共享配额，删除课程不影响配额，按用户注册日期周期重置（需Cron Job，见04_TECH §13.1）

**配额扣除时机**（v2.0异步生成模式）：
* **自动讲解（异步）**：请求发起时立即预扣配额，生成失败自动退款
* **其他AI操作（同步）**：仅当AI返回完整响应时扣除配额，失败不扣

### 3.2 配额重置机制

**重置规则**：

| 配额类型 | 重置周期 | 重置时间 |
|---------|---------|----------|
| 所有AI配额 | 每月 | 基于注册日期（如7号注册则每月7号00:00 UTC） |

**触达行为**：
* 返回HTTP 403 + `QUOTA_EXCEEDED`（见03_API §7）
* 前端提示："本月配额已用尽（X/Y），将于M月D日重置。"

### 3.3 配额退还机制（v2.0异步生成模式）

**原则**：用户为"获得有效AI响应"付费，系统故障不应消耗配额

| 场景 | 判定条件 | 是否退还 | 用户提示 |
|------|---------|---------|---------|
| AI服务超时 | 请求发出后30s未收到首token | ✅ 自动退还 | Toast: "生成超时，配额已退还" |
| AI返回错误 | OpenAI API返回5xx或明确错误 | ✅ 自动退还 | Toast: "生成失败（RequestID: xxx），配额已退还" |
| Worker任务失败 | 最大重试3次后仍失败 | ✅ 自动退还 | P4通知: "提取失败，配额已退还" |
| 网络中断 | 用户侧断网，请求未到达服务器 | N/A 不扣除 | 前端提示: "请检查网络连接" |
| 命中缓存 | 技术上未调用AI，但用户主动触发 | ❌ 不退还 | 提示"此内容已生成过，仍将消耗配额" |
| 用户不满意结果 | AI已完整响应 | ❌ 不退还 | 提供"Regenerate"按钮（再次消耗配额） |
| 重复请求同一内容 | 防止滥用 | ❌ 不退还 | 前端置灰已讲解的页码 |
| 用户删除数据 | 删除课程/文件 | ❌ 不退还 | 删除前二次确认 |

**退还实现**：
- UPDATE quota SET used = used - 1（原子操作）
- quota_log表记录每次退还的原因、时间、requestId
- P8 Usage页面显示"已退还次数"（灰色文本，不计入used）

### 3.4 前端提示规则

**接近上限**（>90%）：
* P4课程详情页顶部黄色警告
* P5按钮旁轻量提示："You're close to the limit..."

**触达上限**：
* 按钮置灰，hover显示tooltip
* 提供"View quota details"链接跳转P7（Settings > Usage标签页）
* 仍可浏览PDF和已有贴纸/总结

---

## 四、非功能需求

### 4.1 性能基线

**测试环境**：Chrome 120+ / Fast 3G / 4x CPU throttling / 中型PDF（20-50页，2-5MB）

| 指标 | 目标值（P75） |
|------|--------------|
| PDF首屏加载（LCP） | <3s |
| 翻页响应 | <100ms（P90） |
| AI首token延迟（TTFB） | <5s |
| AI完整响应 | <15s（P90） |

### 4.2 技术选型（固定）

* **BaaS**：Supabase（Auth+Postgres+Storage），仅server-side使用
* **LLM**：OpenAI API，仅server-side调用
* **前端**：Next.js App Router + TypeScript + Tailwind + TanStack Query

### 4.3 安全性要求

#### 4.3.1 认证与授权

| 层级 | 机制 | 实现检查点 |
|------|------|-----------|
| 用户认证 | Supabase Auth + 邮箱验证 | 注册流程，登录态httpOnly cookie |
| 用户授权 | Row Level Security（RLS） | 所有表强制RLS，`auth.uid()`检查用户身份 |
| 管理员认证 | ADMIN_SECRET环境变量 | Admin API需校验`x-admin-secret`请求头 |

#### 4.3.2 输入校验与存储限制

| 校验项 | 限制值 | 错误响应 |
|--------|--------|---------|
| 文件类型 | 仅.pdf | 400 INVALID_FILE_TYPE |
| 文件大小 | ≤100MB | 400 FILE_TOO_LARGE |
| 文件数量 | ≤50文件/课程 | 400 FILE_LIMIT_EXCEEDED |
| 页数限制 | ≤200页/文件 | 400 PAGE_LIMIT_EXCEEDED |
| 用户存储 | ≤5GB/用户 | 400 STORAGE_LIMIT_EXCEEDED |
| 课程数量 | ≤6门/用户 | 400 COURSE_LIMIT_EXCEEDED |

#### 4.3.3 数据隔离与级联删除

- **RLS策略**：所有用户表（courses/files/stickers/quotas）均启用RLS，用户只能访问自己的数据
- **级联删除**：数据库schema使用`ON DELETE CASCADE`，删除课程时自动删除子数据
- **共享数据保护**：跨用户共享的数据（pdf_context_entries/shared_sticker_cache）不受单用户删除影响

#### 4.3.4 敏感操作保护

| 操作 | 保护机制 |
|------|---------|
| 删除课程 | 二次确认（输入课程名） |
| 删除文件 | 弹窗确认 |
| 删除账户 | 输入"DELETE"确认 |
| Admin调整配额 | 需ADMIN_SECRET + 操作记录日志 |

### 4.4 可靠性与错误处理

#### 4.4.1 统一错误处理

- **错误码体系**：见03_API §6（UNAUTHORIZED、QUOTA_EXCEEDED、INVALID_INPUT等）
- **HTTP状态码**：4xx（用户侧错误）、5xx（系统侧错误）
- **错误响应格式**：`{error: {code, message, details?}}`

#### 4.4.2 Worker任务可靠性（上下文提取）

| 机制 | 配置 |
|------|------|
| 重试策略 | 最多3次，指数退避（60s/120s/240s） |
| 锁超时 | 5分钟 |
| 并发控制 | 全局10并发，单用户2并发 |
| 任务清理 | 完成/失败任务保留7天 |
| 断点续传 | 按批次处理，记录进度 |

#### 4.4.3 配额退还保障

- **自动退还**：AI服务超时、返回错误、Worker任务失败时自动退还配额
- **原子操作**：使用数据库事务保证配额扣除/退还的一致性
- **审计日志**：quota_log表记录每次配额变动的原因、时间、requestId

---

## 五、验收标准（核心）

### 5.1 功能完整性

- [ ] 注册/登录/登出流程可跑通（含邮箱验证）
- [ ] 创建课程、上传PDF、在P4查看资料
- [ ] 在P5完成：自动讲解、选中讲解、追问链、问答、总结
- [ ] 扫描件PDF显示说明，AI功能禁用

### 5.2 配额控制有效性

**按账户全局**：
- [ ] 所有课程共享配额，在Calculus I用掉100次learningInteractions后，剩余50次可用于任何课程
- [ ] P4显示账户全局剩余配额
- [ ] P7 Settings > Usage标签页显示账户级配额使用情况

**触顶行为**：
- [ ] API返回HTTP 403 + `QUOTA_EXCEEDED`
- [ ] 前端禁用按钮并显示提示
- [ ] 配额按注册日期周期重置，本月用尽下个周期自动恢复

### 5.3 性能达标

- [ ] 中型PDF首屏加载P75 ≤ 3秒（Lighthouse验收）
- [ ] AI响应P75 ≤ 5秒返回首token或loading反馈

---

## 六、范围外（MVP不做）

* 多人协作/分享课程
* 移动端专门适配
* 题库与刷题功能
* 用户编辑贴纸内容或添加个人备注
* 复杂学习路径推荐
* 贴纸删除功能（仅支持折叠）
* 用户自助数据导出
