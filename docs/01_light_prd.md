# StudentAid Web - Light PRD（精简版）

> **文档定位**：产品需求基线，定义"做什么"和"为什么"；技术实现见03/04文档。

---

## 一、项目背景与目标

### 1.1 背景

* 大学生复习"硬课"（高数/线代/统计）时，PDF资料分散难管理
* 现有AI工具缺乏"课程+PDF"一体化讲解能力
* 考前冲刺需要：**资料集中 + PDF讲解 + 考点提纲**

### 1.2 MVP目标

> 帮助大学生在考前复习场景下，以课程为单位管理PDF资料，并通过AI讲解快速掌握高频考点。

**核心能力**：
1. **资料集中管理**：按课程组织Lecture/Homework/Exam PDF
2. **PDF + AI学习**：同屏完成"看讲义 + 看AI讲解（贴纸）+ 追问"
3. **课程级提纲**：基于多份PDF生成考点清单

---

## 二、核心用户与场景

### 2.1 目标用户

* **人群**：理工科/商科本科生/研究生（有较多"硬课"）
* **特征**：平时跟课一般，考前需突击；资料来源混杂（LMS/邮件/群组）；重解题和应试
* **能力**：熟悉PDF/网盘工具；了解AI工具；依赖逐步讲解建立直觉

### 2.2 关键场景

| 场景 | 触发时机 | 目标 | 核心流程 |
|------|---------|------|---------|
| **跟课理解** | 每周课后/作业前 | 快速搞懂推导和公式 | 打开讲义 → 解释当前页 → 选中讲解 → 问答 |
| **考前冲刺** | 考前1-2周 | 构建知识框架+高频考点 | 上传全部PDF → 生成文档总结 → 课程级提纲 |
| **难题突破** | 遇到难题/推导 | 理解某几页/段落 | 定位页面 → 解释当前页 → 选中讲解 → 多轮追问 |

---

## 三、功能模块（核心）

### 3.1 学习与AI模块布局

**P5页面结构**：
* **左侧**：PDF阅读器（分页/缩放/记忆lastReadPage）
* **右侧**：AI学习区
  * **上部**：贴纸栏（自动讲解 + 选中讲解）
  * **下部**：问答与总结区

### 3.2 四类AI能力

| 能力 | 角色 | 触发方式 | 计费规则 |
|------|------|---------|---------|
| **自动讲解** | 像老师划重点 | 点击"Explain this page" | 20次/文件/天（不计入配额） |
| **选中讲解** | 针对具体公式/句子精讲 | 选中文本 → AI讲解 | 计入`learningInteractions` |
| **问答（Q&A）** | 回答跨页综合问题 | 问答区输入问题 | 计入`learningInteractions` |
| **总结** | 生成结构化提纲 | 文档/章节/课程总结按钮 | 各计入独立配额桶 |

**PDF类型差异**：
* **Lecture**：内容概览 + 概念讲解 + 公式直觉
* **Homework/Exam**：考点分析 + 思路提示（不直接给答案）

### 3.3 贴纸机制

**类型与来源**：
* **自动贴纸**（`type: "auto"`）：系统按页生成2-6条，对齐原文位置
* **手动贴纸**（`type: "manual"`）：用户选中触发，支持追问链（`parentId`指向上一条）

**表现与持久化**：
* 视觉区分：不同背景色/标签（"Auto" / "From selection"）
* 支持折叠/展开，状态持久化
* 单条贴纸最大高度300-400px，超出内部滚动
* 重开文档恢复所有贴纸及折叠状态

### 3.4 扫描件处理

* **检测**：上传时检测文本层（平均<50字符/页视为扫描件）
* **行为**：
  * P5右侧提示"不支持AI讲解"
  * 隐藏"Explain this page"和选中讲解入口
  * 左侧PDF阅读器正常可用

### 3.5 统一富文本格式

所有AI输出（贴纸/问答/总结）统一为**Markdown文本**：
* **格式**：标题/粗体/列表/表格/引用等完整语法
* **公式**：行内`$...$`，块级`$$...$$`（KaTeX渲染）
* **代码**：三反引号+语言标记（如` ```python`）
* **约束**：后端不返回HTML，前端统一用`MarkdownRenderer`渲染

---

## 四、配额与限流策略

### 4.1 配额粒度设计

**设计原则**：以课程为中心，避免单课程耗尽全局配额

| 类型 | 粒度 | 默认值 | 说明 |
|------|------|--------|------|
| **课程数量** | `(userId)` | 6门 | 用户级全局限制 |
| **AI配额** | `(userId, courseId)` | 见下表 | 每门课独立计数 |

**AI配额桶**（按课程）：

| 配额桶 | 包含操作 | 限制 |
|--------|---------|------|
| `learningInteractions` | 选中讲解（PDF/贴纸）+ 问答 | 50次/课程 |
| `documentSummary` | 文档总结 | 10次/课程 |
| `sectionSummary` | 章节总结 | 15次/课程 |
| `courseSummary` | 课程级提纲 | 3次/课程 |

### 4.2 自动讲解限流

**为何不计入配额**：视为"系统辅助"而非主动消耗，鼓励用户先整体理解再精读

**限流规则**：

| 维度 | 粒度 | 限制 | 重置时间 |
|------|------|------|---------|
| 按文件每日 | `(userId, fileId, date_UTC)` | 20次/天 | 每日00:00 UTC |
| 单次请求 | - | 最多生成6条贴纸 | - |

**触达行为**：
* 返回HTTP 429 + `AUTO_EXPLAIN_LIMIT_REACHED`
* 提示："今日自动讲解已用完（20/20），明日00:00 UTC重置。您仍可使用选中文本讲解。"
* 不影响其他功能

### 4.3 前端提示规则

**接近上限**（>90%）：
* P4课程详情页顶部显示黄色警告
* P5按钮旁显示轻量提示："You're close to the limit..."

**触达上限**：
* 按钮置灰，hover显示tooltip
* 提供"View quota details"链接跳转P7
* 仍可浏览PDF和已有贴纸/总结

---

## 五、非功能需求（可测量）

### 5.1 性能基线

**测试环境**：Chrome 120+ / Fast 3G / 4x CPU throttling / 中型PDF(20-50页, 2-5MB)

| 指标 | 目标值(P75) | 验收标准 |
|------|------------|---------|
| PDF首屏加载(LCP) | <3s | Lighthouse测量 |
| 翻页响应 | <100ms(P90) | Performance API |
| AI首token延迟(TTFB) | <5s | 请求到首响应 |
| AI完整响应 | <15s(P90) | 流式响应结束 |
| 页面交互(INP) | <200ms(P75) | Core Web Vitals |

**优化策略**：
* 大型PDF（>50页）使用虚拟滚动（仅渲染可见页±2）
* AI接口启用streaming，逐字显示
* 超时处理：15s未完成显示"处理中"，30s超时并提示重试

### 5.2 安全与兼容性

* **安全**：用户PDF仅本人可见；密码加密存储；明确标注"实验性项目"
* **兼容**：优先桌面端Chrome/Edge/Safari最新版；移动端基础适配

### 5.3 技术选型（固定）

* **BaaS**：Supabase（Auth + Postgres + Storage），仅server-side使用
* **LLM**：OpenAI API，仅server-side调用
* **前端**：Next.js App Router + TypeScript + Tailwind + TanStack Query

---

## 六、验收标准（核心）

### 6.1 功能完整性

- [ ] 注册/登录/登出流程可跑通（含邮箱验证）
- [ ] 创建课程、上传PDF、在P4查看资料
- [ ] 在P5完成：
  - [ ] "Explain this page"生成自动贴纸
  - [ ] 选中文本生成手动贴纸和追问链
  - [ ] 问答区发起问题
  - [ ] 生成文档/章节总结

### 6.2 AI质量基线

* **样本**：高数/线代/统计各1份PDF，抽样10页+5道题
* **验证点**：
  * Lecture：能解释推导、给出例子、总结要点
  * Homework/Exam：以考点和思路为主，不直接给完整答案
  * 公式渲染正确，无明显LaTeX语法错误
  * 幻觉率：定性评估，形成改进计划

### 6.3 贴纸与交互

- [ ] 自动/手动贴纸样式有明显区分
- [ ] 贴纸可折叠/展开，状态重开文档后恢复
- [ ] 点击贴纸可联动PDF滚动到对应位置
- [ ] 扫描件PDF显示说明，AI功能禁用

### 6.4 配额控制有效性

**按课程维度**：
- [ ] Calculus I用完配额不影响Linear Algebra
- [ ] P4显示当前课程剩余配额
- [ ] P7按课程分组展示

**触顶行为**：
- [ ] API返回HTTP 429 + 对应错误码
- [ ] 前端禁用按钮并显示提示
- [ ] 提供"View details"跳转P7

**自动讲解限流**：
- [ ] 触达20次/天返回`AUTO_EXPLAIN_LIMIT_REACHED`
- [ ] 前端提示"今日已用完，明日00:00 UTC重置"
- [ ] 不影响选中讲解和问答

**日志可查**：
- [ ] 可按`(userId, courseId, bucket)`查询配额消耗
- [ ] 可按`(userId, fileId, date)`查询自动讲解使用

### 6.5 性能达标

- [ ] 中型PDF首屏加载P75 ≤ 3秒（Lighthouse验收）
- [ ] AI响应P75 ≤ 5秒返回首token或明确loading反馈

---

## 七、范围外（MVP不做）

* 多人协作/分享课程
* 移动端专门适配
* 题库与刷题功能
* 用户编辑贴纸内容或添加个人备注
* 复杂学习路径推荐
* 贴纸删除功能（仅支持折叠）
